{% extends "base.html" %}
{% block title %}Dashboard de Gastos{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Estilo do container principal */
    .dashboard-container {
        width: 90%;
        max-width: 1200px;
        margin: 30px auto;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, 
                     Helvetica, Arial, sans-serif;
    }

    .dashboard-container h1 {
        text-align: center;
        color: var(--primary-color, #0096c7);
    }

    /* --- Cards de estatísticas --- */
    .stat-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background-color: var(--card-bg-color, #fff);
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--shadow-color, rgba(0,0,0,0.08));
        transition: background-color 0.3s, color 0.3s;
        color: var(--text-color, #333);
    }

    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 1rem;
        color: var(--label-color, #555);
        font-weight: 600;
    }

    .stat-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color, #0096c7);
    }
    
    body.dark-mode .stat-card {
        background-color: #1e1e1e;
        color: #ddd;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    body.dark-mode .stat-card h3 {
        color: #bbb;
    }
    body.dark-mode .stat-card .value {
        color: var(--primary-color, #4cc9f0);
    }

    /* --- Área de gráficos e listas --- */
    .charts-area {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-top: 30px;
    }

    .chart-container, .list-container {
        background-color: var(--card-bg-color, #fff);
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 12px var(--shadow-color, rgba(0,0,0,0.08));
        transition: background-color 0.3s, color 0.3s;
        color: var(--text-color, #333);
    }

    /* --- Ajustes para o modo escuro --- */
    body.dark-mode .chart-container,
    body.dark-mode .list-container {
        background-color: #1e1e1e;
        color: #ddd;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    .list-container h3 {
        margin-top: 0;
        color: var(--primary-color, #0096c7);
    }
    body.dark-mode .list-container h3 {
        color: var(--primary-color, #4cc9f0);
    }

    .list-container ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .list-container li {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid var(--border-color, #e0e0e0);
    }
    .list-container li:last-child {
        border-bottom: none;
    }

    .list-container .description {
        font-weight: 600;
    }
    .list-container .value {
        font-weight: 600;
        color: var(--danger-color, #e63946);
    }
    .list-container .date {
        font-size: 0.85em;
        color: #777;
    }

    body.dark-mode .list-container li {
        border-bottom: 1px solid #333;
    }
    body.dark-mode .list-container .date {
        color: #999;
    }

    /* Responsividade */
    @media (max-width: 900px) {
        .charts-area {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 768px) {
        .dashboard-container { width: 95%; }
    }
</style>


<div class="dashboard-container">
    <h1>Meu Dashboard</h1>

    <div class="stat-cards">
        <div class="stat-card">
            <h3>Total Gasto (Geral)</h3>
            <span class="value">R$ {{ total_spent|floatformat:2 }}</span>
        </div>
        <div class="stat-card">
            <h3>Gasto nos últimos 30 dias</h3>
            <span class="value">R$ {{ recent_spent|floatformat:2 }}</span>
        </div>
        <div class="stat-card">
            <h3>Média por Transação</h3>
            <span class="value">R$ {{ average_spent|floatformat:2 }}</span>
        </div>
        <div class="stat-card">
            <h3>Total de Transações</h3>
            <span class="value">{{ transaction_count }}</span>
        </div>
    </div>

    <div class="charts-area">
        
        <div class="chart-container">
            <canvas id="categoryPieChart"></canvas>
        </div>

        <div class="list-container">
            <h3>Últimos 5 Gastos</h3>
            <ul>
                {% for expense in recent_transactions %}
                <li>
                    <div>
                        <div class="description">{{ expense.description|truncatechars:30 }}</div>
                        <div class="date">{{ expense.update_at|date:"d/m/Y" }}</div>
                    </div>
                    <div class="value">- R$ {{ expense.value|floatformat:2 }}</div>
                </li>
                {% empty %}
                <li>Nenhuma transação encontrada.</li>
                {% endfor %}
            </ul>
        </div>

    </div>
</div>


{{ chart_labels|json_script:"chart-labels" }}
{{ chart_data|json_script:"chart-data" }}

<script>
    // Pega os dados que o Django preparou
    const labels = JSON.parse(document.getElementById('chart-labels').textContent);
    const data = JSON.parse(document.getElementById('chart-data').textContent);

    // Configuração do gráfico
    const pieChartData = {
        labels: labels,
        datasets: [{
            label: 'Gastos por Categoria',
            data: data,
            // Você pode adicionar mais cores aqui
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#E7E9ED', '#F7464A'
            ],
            hoverOffset: 4
        }]
    };

    // Renderiza o gráfico no <canvas>
    const ctx = document.getElementById('categoryPieChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut', // 'pie' ou 'doughnut' (rosca)
        data: pieChartData,
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Gastos por Categoria'
                }
            }
        },
    });
</script>

{% endblock %}